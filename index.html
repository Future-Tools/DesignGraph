<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>UML Interactive Graph</title>
  <style>
    body { margin: 0; background: #0b0e2c; }
    #3d-graph { width: 100vw; height: 100vh; }
  </style>

  <!-- âœ… Load required libraries in correct order -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/3d-force-graph"></script>
</head>

<body>
  <div id="3d-graph"></div>

 <script>
  const gData = {
    nodes: [
      { id: 'Application' },
      { id: 'User' },
      { id: 'Organisation' },
      { id: 'Role' },
      { id: 'Permission' },
      { id: 'AuditLog' }
    ],
    links: [
      { source: 'Application', target: 'User' },
      { source: 'User', target: 'Role' },
      { source: 'Role', target: 'Permission' },
      { source: 'Organisation', target: 'User' },
      { source: 'Application', target: 'AuditLog' }
    ]
  };

  let highlightedNodeIds = new Set();
  let highlightedLinkIds = new Set(); // Use string IDs for links

  // Helper to get unique link ID
  function linkId(link) {
    const src = typeof link.source === 'object' ? link.source.id : link.source;
    const tgt = typeof link.target === 'object' ? link.target.id : link.target;
    return `${src}--${tgt}`;
  }

  // Create graph instance
  const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
    .graphData(gData)
    .backgroundColor("#0b0e2c")
    .nodeAutoColorBy("id")
    .nodeLabel(node => node.id)
    .linkWidth(link => highlightedLinkIds.has(linkId(link)) ? 6 : 2) // 2 for normal, 6 for highlighted
    .linkColor(link => highlightedLinkIds.has(linkId(link)) ? 'cyan' : '#ffffff')
    .nodeThreeObject(node => {
      const group = new THREE.Group();

      // Node sphere
      const geometry = new THREE.SphereGeometry(4, 32, 32);
      const material = new THREE.MeshStandardMaterial({
        color: highlightedNodeIds.has(node.id) ? 'orange' : node.color
      });
      const sphere = new THREE.Mesh(geometry, material);
      group.add(sphere);

      // Add label if highlighted (clicked or neighbor)
      if (highlightedNodeIds.has(node.id)) {
        const label = makeTextSprite(node.id);
        label.position.set(0, 10, 0);
        group.add(label);
      }

      return group;
    })
    .nodeThreeObjectExtend(true)
    .onNodeClick(node => {
      highlightedNodeIds.clear();
      highlightedLinkIds.clear();

      highlightedNodeIds.add(node.id);

      // Highlight connected links and neighbor nodes
      gData.links.forEach(link => {
        const src = typeof link.source === 'object' ? link.source.id : link.source;
        const tgt = typeof link.target === 'object' ? link.target.id : link.target;

        if (src === node.id) {
          highlightedNodeIds.add(tgt); // neighbor
          highlightedLinkIds.add(linkId(link));
        } else if (tgt === node.id) {
          highlightedNodeIds.add(src); // neighbor
          highlightedLinkIds.add(linkId(link));
        }
      });

      // Refresh visuals
      Graph.nodeThreeObject(Graph.nodeThreeObject);
      Graph.linkWidth(Graph.linkWidth);
      Graph.linkColor(Graph.linkColor);

      // Zoom to selected node
      const distance = 40;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
      Graph.cameraPosition(
        { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
        node,
        3000
      );
    })
    .lights([
      new THREE.AmbientLight(0xcccccc, 1.5),
      new THREE.DirectionalLight(0xffffff, 0.6)
    ]);

  function makeTextSprite(text) {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    context.font = "24px Arial";
    context.fillStyle = "white";
    context.fillText(text, 4, 24);

    const texture = new THREE.CanvasTexture(canvas);
    const material = new THREE.SpriteMaterial({ map: texture });
    const sprite = new THREE.Sprite(material);
    sprite.scale.set(30, 15, 1.0);
    return sprite;
  }
</script>

</body>
</html>
